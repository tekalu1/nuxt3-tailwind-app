---
name: root-cause-analysis
description: 問題の根本原因を特定するためのなぜなぜ分析を実施。バグ、障害、不具合の原因調査時に使用。直接原因とテスト工程での検知漏れ原因の両面から深掘りし、プロセス改善案を提示する。
---

# なぜなぜ分析（Root Cause Analysis）

問題やバグに対して体系的に根本原因を特定し、再発防止策を提案するスキルです。

## 分析フレームワーク

問題が発生した場合、以下の2軸で「なぜ」を5回以上繰り返して深掘りします。

### 軸1: 直接原因の深掘り（なぜ問題が発生したか）

```
問題: [具体的な事象]
  ↓ なぜ？
原因1: [直接的な原因]
  ↓ なぜ？
原因2: [より深い原因]
  ↓ なぜ？
原因3: [さらに深い原因]
  ↓ なぜ？
原因4: [根本に近い原因]
  ↓ なぜ？
原因5: [根本原因] ★ここが真因
```

### 軸2: 検知漏れ原因の深掘り（なぜテストで検知できなかったか）

```
問題: テスト工程で検知できなかった
  ↓ なぜ？
原因1: [テストケースがなかった/不十分だった]
  ↓ なぜ？
原因2: [そのパターンを自動生成する仕組みがなかった]
  ↓ なぜ？
原因3: [型定義やインターフェースが曖昧だった]
  ↓ なぜ？
原因4: [設計段階で境界条件が明確化されていなかった]
  ↓ なぜ？
原因5: [型システムやスキーマで制約を表現できていなかった] ★ここが真因
```

## 分析の進め方

### Step 1: 問題の明確化

- **何が起きたか**: 具体的な事象を記述
- **いつ発生したか**: タイムライン
- **どこで発生したか**: 該当箇所（ファイル、関数、コンポーネント）
- **影響範囲**: 誰に、何に影響があったか

### Step 2: 事実の収集

問題を再現し、関連するコード、ログ、設定を確認する。
- エラーメッセージ、スタックトレース
- 関連するコード変更（git log, git blame）
- 設定ファイル、環境変数
- 関連するテストコード

### Step 3: 直接原因の分析（5 Whys）

「なぜ」を最低5回繰り返す。各段階で：
- **事実に基づく**: 推測ではなく、コードや証拠から導く
- **具体的に**: 抽象的な表現を避ける
- **複数経路を検討**: 原因が複数ある場合は分岐させる

### Step 4: 検知漏れ原因の分析（5 Whys）

テスト工程で検知できなかった理由を同様に深掘り：
- 単体テストは存在したか？
- 統合テストでカバーされていたか？
- E2Eテストのシナリオに含まれていたか？
- コードレビューで指摘できなかったのはなぜか？

### Step 5: 根本原因の特定

両軸の分析から、真の根本原因を特定する。
根本原因の特徴：
- これを解決すれば再発しない
- プロセスや仕組みの問題に行き着く
- 「人のミス」で終わらせない

### Step 6: 改善策の提案

根本原因に対して、以下の3レベルで改善策を提案する：

| レベル | 対象 | 例 |
|--------|------|-----|
| **即時対応** | 当該問題の修正 | バグ修正、ホットフィックス |
| **短期改善** | 類似問題の予防 | 型定義の厳格化、自動テスト追加 |
| **長期改善** | 設計・アーキテクチャの改善 | 型システム強化、CI自動チェック追加 |

## 改善策の優先順位（重要）

**工数を増やす改善策は極力避ける。** 以下の優先順位で改善策を検討すること：

### 優先度1: 自動化による解決（工数削減）

人手を介さず、機械的に問題を防止・検知できる方法を最優先で検討する。

| 手法 | 効果 | 例 |
|------|------|-----|
| **型システムの活用** | コンパイル時にエラー検出 | TypeScript strict mode、Zod スキーマ、branded types |
| **静的解析の追加** | CI で自動検出 | ESLint ルール追加、カスタムルール作成 |
| **自動テスト生成** | テストパターンを自動網羅 | プロパティベーステスト、スナップショットテスト |
| **CI/CD パイプライン強化** | マージ前に自動ブロック | 型チェック必須化、テストカバレッジ閾値 |

### 優先度2: 設計改善による解決（工数変わらず）

コードの書き方や設計を変えることで、そもそも問題が起きにくくする。

| 手法 | 効果 | 例 |
|------|------|-----|
| **インターフェース設計の改善** | 誤用を構造的に防止 | 必須パラメータの明確化、Builder パターン |
| **デフォルト値の見直し** | 安全側に倒す | fail-safe 設計、明示的な初期化 |
| **関数シグネチャの改善** | 引数の取り違え防止 | オブジェクト引数、named parameters |
| **エラーハンドリングの型安全化** | 例外の見落とし防止 | Result 型、Either パターン |

### 優先度3: ツール導入による解決（初期工数のみ）

一度導入すれば継続的に効果を発揮するツールを検討する。

| 手法 | 効果 | 例 |
|------|------|-----|
| **フォーマッター/リンター設定** | コードスタイル統一 | Prettier、ESLint 設定強化 |
| **エディタ設定の共有** | 開発時に即座にフィードバック | .vscode/settings.json、推奨拡張機能 |
| **Git hooks** | コミット前に自動チェック | husky + lint-staged |
| **依存関係の自動更新** | 脆弱性の早期検知 | Dependabot、Renovate |

### 優先度4: 手動プロセスの追加（最後の手段）

上記で解決できない場合のみ、手動プロセスを検討する。
**ただし、以下は原則として避ける：**

- ❌ チェックリストの追加
- ❌ レビュー観点の追加
- ❌ 手動での確認ステップ追加
- ❌ ドキュメント読み合わせ

これらは工数増加に直結し、形骸化しやすい。
どうしても必要な場合は、将来的に自動化できないか検討すること。

## 出力フォーマット

分析結果は以下のフォーマットで整理する：

```markdown
## なぜなぜ分析レポート

### 1. 問題の概要
- **事象**:
- **発生日時**:
- **影響範囲**:
- **該当箇所**:

### 2. 直接原因の分析

| 深度 | なぜ？ | 原因 | 根拠 |
|------|--------|------|------|
| 1 | なぜ問題が発生したか | | |
| 2 | なぜ[原因1]が起きたか | | |
| 3 | なぜ[原因2]が起きたか | | |
| 4 | なぜ[原因3]が起きたか | | |
| 5 | なぜ[原因4]が起きたか | **[根本原因]** | |

### 3. 検知漏れ原因の分析

| 深度 | なぜ？ | 原因 | 根拠 |
|------|--------|------|------|
| 1 | なぜテストで検知できなかったか | | |
| 2 | なぜ[原因1]だったか | | |
| 3 | なぜ[原因2]だったか | | |
| 4 | なぜ[原因3]だったか | | |
| 5 | なぜ[原因4]だったか | **[根本原因]** | |

### 4. 根本原因のまとめ
- **直接原因の根本**:
- **検知漏れの根本**:

### 5. 改善策

#### 即時対応（今回の修正）
- [ ]

#### 自動化による再発防止（優先度1）
- [ ] 型システム強化:
- [ ] 静的解析ルール追加:
- [ ] CI チェック追加:

#### 設計改善（優先度2）
- [ ] インターフェース改善:
- [ ] エラーハンドリング改善:

#### ツール導入（優先度3）
- [ ]

#### 手動プロセス（優先度4・最終手段）
- [ ] ※上記で解決できない場合のみ
```

## 分析時の注意点

### やってはいけないこと

- **「人のミス」で止まる**: 「担当者の確認不足」ではなく、なぜ確認できる仕組みがなかったかを追求
- **推測で進める**: 必ずコード、ログ、履歴などの証拠に基づく
- **犯人探し**: 誰が悪いかではなく、何が問題かに焦点を当てる
- **浅い分析で終わる**: 最低5回は「なぜ」を繰り返す
- **工数を増やす改善策を安易に提案する**: チェックリスト追加、レビュー観点追加、手動確認ステップ追加は最後の手段。まず自動化・設計改善を検討する

### 良い分析の特徴

- 事実ベースで論理的
- 複数の視点（開発・テスト・設計）から分析
- 再発防止に直結する改善策が導出される
- **改善策が工数を増やさない（むしろ減らす）**
- 自動化・型システム・設計改善を優先した提案
- チームで共有可能な形式で文書化

## 使用例

ユーザーから以下のような依頼があった場合に使用：

- 「このバグの原因を調査して」
- 「なぜこの問題が起きたか分析して」
- 「障害の根本原因を特定したい」
- 「なぜテストで見つけられなかったのか知りたい」
- 「再発防止策を考えて」
