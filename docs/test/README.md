# テストプロセス

プロジェクトのテスト作成・実行プロセスについて説明します。

---

## テストの種類

本プロジェクトでは以下の3種類のテストを実施します。

| テスト種別 | 目的 | ツール | 実行タイミング |
|-----------|------|--------|---------------|
| ユニットテスト | 個別関数・コンポーネントの検証 | Vitest | 開発中・CI |
| 統合テスト | API・サービス間連携の検証 | Vitest | 開発中・CI |
| E2Eテスト | ユーザーフロー全体の検証 | Playwright | PR・リリース前 |

---

## テスト作成プロセス

### 全体フロー

```
┌──────────────────┐
│  機能要件定義     │  requirements/features/*.md
│  (何を作るか)     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  テストシナリオ   │  test/{type}/scenarios/*.md
│  (どうテストするか)│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  パターンマトリクス │  (シナリオ内に記載)
│  (どの条件を網羅) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  テストケース抽出 │  (シナリオ内に記載)
│  (具体的なケース) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  テストコード実装 │  tests/{type}/**/*.test.ts
│  (実行可能なテスト)│
└──────────────────┘
```

### 各ステップの詳細

#### 1. 機能要件定義

まず、テスト対象の機能要件を確認します。

- 参照: `docs/requirements/features/{画面名}.md`
- 機能ID (FR-XXX-NNN) を把握する

#### 2. テストシナリオ作成

機能要件に基づき、テストシナリオを作成します。

- 格納先: `docs/test/{type}/scenarios/{機能名}.md`
- ユーザーストーリーを記述
- 前提条件を明確化

#### 3. パターンマトリクス作成

テスト条件の組み合わせを洗い出します。

```markdown
| 条件1 | 条件2 | 条件3 | 期待結果 | 優先度 |
|-------|-------|-------|---------|--------|
| A     | X     | true  | 成功    | 高     |
| A     | Y     | false | エラー  | 高     |
| B     | X     | true  | 成功    | 中     |
```

#### 4. テストケース抽出

マトリクスから具体的なテストケースを抽出します。

```markdown
| ID | カテゴリ | ケース | パターン参照 | 実装状況 |
|----|---------|--------|-------------|---------|
| TC-E2E-USER-001 | 正常系 | ユーザーを登録できる | P1 | 実装済 |
| TC-E2E-USER-002 | 異常系 | 必須項目未入力でエラー | P2 | 未実装 |
```

#### 5. テストコード実装

テストケースを実行可能なコードとして実装します。

- 格納先: `tests/{type}/**/*.test.ts`
- ケースIDをコメントに記載

---

## ディレクトリ構造

```
docs/test/
├── README.md                    # 本ドキュメント
├── integration/                 # 統合テスト
│   ├── README.md               # 統合テストガイド
│   └── scenarios/              # シナリオドキュメント
│       ├── _template.md        # テンプレート
│       └── {機能名}.md         # 各機能のシナリオ
└── e2e/                        # E2Eテスト
    ├── README.md               # E2Eテストガイド
    └── scenarios/              # シナリオドキュメント
        ├── _template.md        # テンプレート
        └── {機能名}.md         # 各機能のシナリオ

tests/
├── unit/                       # ユニットテストコード
├── integration/                # 統合テストコード
└── e2e/                        # E2Eテストコード
```

---

## シナリオ・パターン網羅チェックリスト

テストシナリオ作成時に以下の観点を確認してください。

### 1. 登録確認テスト

UIで提供される機能がバックエンドに実装されているか確認します。

```typescript
// 例: Piniaストアのアクションが正しく登録されているか確認
const userStore = useUserStore()
const expectedActions = ['fetchUsers', 'createUser', 'updateUser', 'deleteUser']
for (const action of expectedActions) {
  expect(typeof userStore[action]).toBe('function')
}
```

### 2. ユーザーフローベーステスト

実際のユーザー操作をシミュレートします。

```typescript
// 例: ユーザー登録フロー
test('ユーザーが新規登録できる', async () => {
  // 1. ユーザー一覧ページにアクセス
  // 2. 新規登録ボタンをクリック
  // 3. ユーザー名・メールアドレスを入力
  // 4. 保存ボタンをクリック
  // 5. ユーザー一覧に追加されていることを確認
})
```

### 3. 境界値テスト

入力値の境界条件をテストします。

| 対象 | 最小 | 最大 | 無効 |
|------|------|------|------|
| ユーザー名 | 1文字 | 50文字 | 空文字, 51文字 |
| 商品数 | 1 | 999 | 0, 1000 |

### 4. エラーパステスト

異常系のシナリオを網羅します。

- ネットワークエラー
- バリデーションエラー
- 権限エラー
- タイムアウト

### 5. UI↔バックエンド整合性テスト

UIで提供される機能とバックエンド実装の整合性を確認します。

```typescript
// 例: UIで表示される商品カテゴリがすべてAPIから取得可能
const productStore = useProductStore()
const uiCategories = ['electronics', 'clothing', 'books']
for (const category of uiCategories) {
  const products = await productStore.fetchByCategory(category)
  expect(products).toBeDefined()
}
```

---

## トレーサビリティ

### ID体系

| 種類 | フォーマット | 例 |
|-----|-------------|-----|
| 機能要件 | `FR-{画面}-{番号}` | FR-USER-001 |
| E2Eテストケース | `TC-E2E-{シナリオ}-{番号}` | TC-E2E-USER-001 |
| 統合テストケース | `TC-IT-{シナリオ}-{番号}` | TC-IT-PRODUCT-001 |

### 相互参照

機能要件書とテストシナリオは相互にリンクします。

```markdown
# 機能要件書内
## テストシナリオへのリンク
- [ユーザー管理E2Eシナリオ](../../test/e2e/scenarios/user-management.md)

# テストシナリオ内
## 関連機能要件
- [FR-USER-001](../../requirements/features/user-management.md#fr-user-001)
```

---

## テスト実行

### コマンド

```bash
# ユニットテスト
pnpm test:unit

# 統合テスト
pnpm test:integration

# E2Eテスト
pnpm test:e2e

# 全テスト
pnpm test
```

### CI/CD

- PR作成時: ユニットテスト + 統合テスト
- マージ時: 全テスト
- リリース前: 全テスト + 手動確認

---

## 関連ドキュメント

- [機能要件ガイド](../requirements/features/README.md)
- [テストガイド](../development/guides/testing-guide.md)
- [統合テストガイド](./integration/README.md)
- [E2Eテストガイド](./e2e/README.md)
